<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/default}">
	  	  
	<th:block layout:fragment="customContents">
		<div class="container-fluid">
			<div class="row justify-content-center">
				<div class="col-12">
					<h2 class="mb-2 page-title">포인트 관련 기준 관리</h2>
					<div class="row my-4">
						<div class="col-md-12 table-margin-bottom">
							<div class="card shadow">
								<div class="card-body">               
									<!-- tab 버튼 -->
									<ul class="nav nav-pills nav-fill mb-3 bottom-border" id="pills-tab" role="tablist">
									    <li class="nav-item">
									      <a class="nav-link nav-tab active" id="pills-max-tab" data-toggle="pill" href="#pills-max" role="tab" aria-controls="pills-max" aria-selected="true">하루 최대 적립 포인트 횟수 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-expire-tab" data-toggle="pill" href="#pills-expire" role="tab" aria-controls="pills-expire" aria-selected="false">포인트 유효 기간 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-type-tab" data-toggle="pill" href="#pills-type" role="tab" aria-controls="pills-type" aria-selected="false">포인트 타입</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-save-tab" data-toggle="pill" href="#pills-save" role="tab" aria-controls="pills-save" aria-selected="false">포인트 적립 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-refund-tab" data-toggle="pill" href="#pills-refund" role="tab" aria-controls="pills-refund" aria-selected="false">포인트 환급 기준</a>
									    </li>
									</ul>
									<div class="tab-content mb-1" id="pills-tabContent">	                 
										<!-- 포인트 기준 동적 테이블 -->
										<div class="tab-pane fade show active" id="pills-max" role="tabpanel" aria-labelledby="pills-max-tab"> 
											<h5 class="mb-2 page-small-title">하루 최대 적립 포인트 횟수 기준</h5>
											<p class="card-small-text"> 하루에 적립 가능한 포인트 횟수는 최대 [[${useMaxCount}]]번입니다.</p>
											<table class="table datatables dataTable no-footer table-hover" id="dataTable-1">
												<thead>
													<tr>
														<th>
															<input type="checkbox" class="custom-control custom-checkbox checkbox allCheck">
														</th>
									                    <th>No.</th>
									                    <th>횟수 기준 코드</th>
									                    <th>적립 가능 횟수</th>
									                    <th>코드 사용 유무</th>
									                    <th>최초 등록일</th>
									                    <th>관리자 ID</th>
									                    <th>최종 수정일</th>
					                  				</tr>
					               			 	</thead>
												<tbody>
										        	<th:block 	th:unless="${#lists.isEmpty(pointStandardList)}"
										                		th:each ="p , state: ${pointStandardList}">
														<tr> 
															<td>
																<input type="checkbox" class="custom-control custom-checkbox checkbox checks">
															</td>
															<td th:text="${p['No']}"></td>
															<td th:text="${p['횟수 기준 코드']}"></td>
															<td th:text="${p['적립 가능 횟수']}"></td>
															<td th:text="${p['코드 사용 유무']}"></td>
															<td th:text="${p['최초 등록일']}"></td>
															<td th:text="${p['관리자 ID']}"></td>
															<td th:text="${p['최종 수정일']}"></td>
														</tr>  
													</th:block>                
												</tbody> 
											</table> 
											<!-- 등록버튼 -->
											<div class="colSpan-left">
											<button type="button" class="btn mb-2 btn-secondary"th:href="@{/admin/point/PointStandardManage}" data-toggle="modal" data-target=".varyModalInsert" data-whatever="@mdo">등록</button>
											<div class="modal fade varyModalInsert"  tabindex="-1" role="dialog" aria-labelledby="varyModalLabelInsert" aria-hidden="true">
												<div class="modal-dialog" role="document">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title" id="varyModalLabelInsert">하루 최대 적립 포인트 횟수 기준 등록</h5>
															<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																<span aria-hidden="true">&times;</span>
															</button>
														</div>
														<div class="modal-body">
															<form>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">적립 가능 횟수:</label>
																	<input type="text" class="form-control" value="횟수">
																</div>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">관리자 ID:</label>
																	<input type="text" class="form-control" readonly="readonly">
																</div>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">비밀번호 : </label>
																	<input type="password" class="form-control">
																</div>
															</form>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn mb-2 btn-secondary" data-dismiss="modal">입력 취소</button>
															<button type="button" class="btn mb-2 btn-secondary">등록 확인</button>
														</div>
													</div>
												</div>
											</div>
											<!-- 수정 버튼 -->
											<button type="button" class="btn mb-2 btn-secondary modalBtn" data-toggle="modal" th:data-target=".modifyBtn">수정</button>
			           									<div class="modal fade modal-div modifyBtn"tabindex="-1" role="dialog" aria-labelledby="varyModalLabelModify" aria-hidden="true">
			              								<div class="modal-dialog" role="document">
													<div class="modal-content">
														<div class="modal-header">
														  <h5 class="modal-title" >하루 최대 적립 포인트 횟수 기준 수정</h5>
														  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
														    <span aria-hidden="true">&times;</span>
														  </button>
			                 										</div>
			                 										<div class="modal-body">
															<form action="" method="Post">
																<div class="form-group">
																  <label th:for="modifyCode" class="col-form-label">코드</label>
																  <input type="text" class="form-control" readonly="readonly" th:value="ㅇㅇ">
																</div>
																<div class="form-group">
																  <label th:for="modifyCount" class="col-form-label">적립 가능 횟수</label>
																  <input type="text" class="form-control" th:value="ㄱㄱ">
																</div>
																<div class="form-group">
																	<label th:for="modifyUse" class="col-form-label">코드 사용 유무</label>
																	<select class="form-control">
																	 	<th:block 	th:unless="${#lists.isEmpty(codeUseList)}"
																					th:each="u : ${codeUseList}">
																		  	<option th:selected="${u} == 1"
																		  			th:value="${u}" 
																		  			th:text="${u}">
																		  	</option>
																		</th:block> 
																	</select>
																</div>
																<div class="form-group">
																	<label th:for="modifyAdmin" class="col-form-label">관리자 ID</label>
																	<input type="text" class="form-control" readonly="readonly" th:value="${SID}" >
																</div>
																<div class="form-group">
																	<label th:for="modifyPw" class="col-form-label">비밀번호</label>
																	<input type="password" class="form-control" >
																</div>
																<button type="reset" class="btn mb-2 btn-secondary">입력 취소</button>
																<button type="button" class="btn mb-2 btn-secondary" >수정 확인</button>
															</form>
														</div>
													</div>
			              						</div>
			           						</div>
											<!-- 삭제 버튼 -->
											<button type="button" class="btn mb-2 btn-secondary select-delete" data-toggle="modal" data-target=".varyModalDelete" data-whatever="@mdo">삭제</button>
											<div class="modal fade varyModalDelete" tabindex="-1" role="dialog" aria-labelledby="varyModalLabelDelete" aria-hidden="true">
												<div class="modal-dialog" role="document">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title" id="varyModalLabelDelete">하루 최대 적립 포인트 횟수 기준 삭제</h5>
															<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																<span aria-hidden="true">&times;</span>
															</button>
														</div>
														<div class="modal-body">
															<form>
																<div class="form-group">
																	<label for="recipient-name" class="col-form-label">코드:</label>
																	<input type="text" class="form-control" readonly="readonly">
																</div>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">적립 가능 횟수:</label>
																	<input type="text" class="form-control" value="횟수">
																</div>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">관리자 ID:</label>
																	<input type="text" class="form-control" readonly="readonly">
																</div>
																<div class="form-group">
																	<label for="message-text" class="col-form-label">비밀번호 : </label>
																	<input type="password" class="form-control">
																</div>
																<button type="button" class="btn mb-2 btn-secondary" data-dismiss="modal">입력 취소</button>
																<button type="button" class="btn mb-2 btn-secondary" id="varyModalDeleteBtn">삭제 확인</button>
															</form>
														</div>
													</div>
												</div>  
										</div>      
										<!-- 포인트 기준 동적 테이블 끝 -->   
									</div>                 
									<!-- tab 끝 -->   
									
										</div>
									</div>		             
								</div>
							</div>
						</div>
					</div> 
				</div>
			</div>
		</div>
	</th:block>
	<th:block layout:fragment="customJs">
		<script>	
		$(function(){
			  $('#dataTable-1').each(function() {
			    const table = $(this);
			    table.DataTable({
			      autoWidth: true,
			      "lengthChange": false, 
			      "pageLength" : 10,
			      "searching" : false,
			      "info": false,
			      "pagingType": "full_numbers",
			        "columnDefs": [
			            {
			                "targets": 1
			            }
			        ],
			      "columnDefs": [{
			            targets: 0,
			            searchable: false,
			            orderable: false,
			            className: 'sorting_disabled'
			            
			      },
			      {
			          targets: table.find('th').length - 1,
			          searchable: false,
			          orderable: false,
			          className: 'sorting_disabled',
			        }]
			      });
			    });
			  
			  $('#dataTable-1').find('.sorting_asc').toggleClass('sorting_asc');
			  });
		


		
		
			// ajax와 제이쿼리로 테이블 동적으로 수정
			$(document).on('click', '.nav-tab, .colSpan button', function(e) { 
				
				
				 $('.checkbox').prop('checked', false);        
			    let tableId;
			    let currentPage;
			
			    if ($(e.target).is('.nav-tab')) {
			        tableId = $(e.target).attr('aria-controls');
			        $('.tab-pane').attr('id', tableId).attr('aria-labelledby', `${tableId}-tab`);
			        currentPage = 1;
			        $('#pills-tab').find('.active').toggleClass('active');
			        $(e.target).toggleClass('active');
			    } else if ($(e.target).is('tfoot button')) {
			        if ($(e.target).text() == '처음으로') currentPage = 1;
			        else if ($(e.target).text() == '이전') currentPage = Number($('.foot-pg').text()) - 1;
			        else if ($(e.target).text() == '다음') currentPage = Number($('.foot-pg').text()) + 1;
			        else if ($(e.target).text() == '마지막으로') currentPage = Number($('.lastPg').data('lastpagenum'));
			        else currentPage = $(e.target).text();
			        tableId = $('.tab-pane.active').attr('id');
			    }
			
			    currentPage = parseInt(currentPage);
			    
			    const copyAllCheck = $('thead').find('th').first().clone(true);
				const copyCheck = $('tbody').find('td').first().clone(true);
				const copyBtn = $('tbody .btn-group').first().clone(true);
				$("tbody tr").remove();
				$("thead th").remove();
			    		
			    console.log(tableId);
				console.log(currentPage);
				
				const requestData = $.ajax({
		 		 	url: '/admin/point/pointStandardManageClick',
					method: 'GET',
					data: { 'tableId' : tableId, 'currentPage' : currentPage},
					dataType: 'json'
		 		});

				requestData.done(function( response ) {
					if(response){
						const pointStandardList = response.pointStandardList;
						const pointStandardListAll = response.pointStandardListAll;
						const rowPerPage = response.rowPerPage;
						const startPageNum = response.startPageNum;
						const endPageNum = response.endPageNum;

				        
				        const colArr = [];
				        $.each(pointStandardList, function (index, item) {
				            let col = {
				                'No.' : item.no, // Assuming item object has 'no' property
				                '유효기간코드' : item.code, // Assuming item object has 'code' property
				                '최초등록일' : item.registerDate, // Assuming item object has 'registerDate' property
				                '관리자ID' : item.adminId, // Assuming item object has 'adminId' property
				            }
				            colArr.push(col);
				        });

	
						console.log(response);
						switch(tableId){
						case 'pills-expire':
							let pointExpire;
							for(let list of pointStandardListAll){
								if(list['코드 사용 유무'] == '사용가능') {
									pointExpire = list['유효 기간'];
								}
							}
							$('.page-small-title').text('포인트 유효 기간 기준');
							$('.card-small-text').text(`포인트 유효 기간은 ${pointExpire}년입니다.`);
							break;
						case 'pills-type':
							$('.page-small-title').text('포인트 타입');
							$('.card-small-text').text('포인트 타입입니다.');
							break;
						case 'pills-save':
							$('.page-small-title').text('포인트 적립 기준');
							$('.card-small-text').text('포인트 적립 및 사용 타입 기준입니다.');
							break;
						case 'pills-refund':
							$('.page-small-title').text('포인트 환급 기준');
							$('.card-small-text').text('포인트 환급 기준입니다.');
							break;
						case 'pills-max':
							let useMaxCount;
							for(let list of pointStandardListAll){
								if(list['코드 사용 유무'] == '사용가능') {
									useMaxCount = list['적립 가능 횟수'];
								}
							}
							$('.page-small-title').text('하루 최대 적립 포인트 횟수 기준');
							$('.card-small-text').text(`하루에 적립 가능한 포인트 횟수는 최대 ${useMaxCount}번입니다.`);								
							break;
						}
									
						/*
						let isTrue = true;
						let count = (currentPage-1) * rowPerPage + 1;						
						for(let list of pointStandardList){
							if(isTrue) {
						        let addTh = '';
						        for(let item in list){
						            addTh += `<th>${item}</th>`;
						        }
						        addTh += `<th>수정/삭제</th>`;
						        $('thead tr').append(copyAllCheck.clone(true), `<th>No.</th>`, addTh);
						        isTrue = false;
						    }

						    let addTd = '';
						    let plusNum = `<td>${count}</td>`;
						    						    
						    for(let item in list){
						        addTd += `<td>${list[item]}</td>`;
						    }

						    let addTr = $('<tr>');
						    addTr.append(copyCheck.clone(true), 
						                plusNum, 
						                $(addTd), 
						                $('<td>').append(copyBtn.clone(true)));
						    $('tbody').append(addTr);
						    count += 1;
						}
						
						const thColspan = $('thead th').length;
						$('.colSpan').attr('colspan',thColspan-2);	
						
						$('.colSpan').empty();
						
						let pageNation;						
						
						if(currentPage == 1) {
							pageNation = `<label class="btn mb-2 btn-secondary firstPg">처음으로</label>`;
							pageNation += `<label class="btn mb-2 btn-secondary prePg">이전</label>`;	
							if(endPageNum == startPageNum) {
								pageNation += `<div class="btn-group mr-2" role="group" aria-label="First group">
												<label class="btn mb-2 btn-secondary foot-pg currentPg">${endPageNum}</label>
												</div>`;
								pageNation += `<label class="btn mb-2 btn-secondary nexPg">다음</label>`;
								pageNation += `<label class="btn mb-2 btn-secondary lasgPg">마지막으로</label>`;
							}else if(endPageNum != startPageNum){
								pageNation += `<div class="btn-group mr-2" role="group" aria-label="First group">`;
								pageNation += `<label class="btn mb-2 btn-secondary foot-pg currentPg">1</label>`;
								for(let i = startPageNum + 1; i <= endPageNum; i += 1){
									pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary currentPg">${i}</button>`;
								}
								pageNation += `</div>`;
								pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary nexPg">다음</button>`;
								pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary lastPg" data-lastpagenum="${endPageNum}">마지막으로</button>`;
							}
						}else if(currentPage != 1) {
							pageNation = `<button type="button" class="btn mb-2 btn-secondary firstPg">처음으로</button>`;
							pageNation += `<button type="button" class="btn mb-2 btn-secondary prePg">이전</button>`;	
							pageNation += `<div class="btn-group mr-2" role="group" aria-label="First group">`;
							for(let i = startPageNum; i <= endPageNum; i += 1){
								if(currentPage == i) pageNation +=`<label class="pages btn foot-pg mb-2 btn-secondary currentPg">${i}</label>`;
								else pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary currentPg">${i}</button>`;
							}
							pageNation += `</div>`;
							if(currentPage == endPageNum){
								pageNation +=`<lable class="pages btn mb-2 btn-secondary nexPg">다음</lable>`;
								pageNation +=`<lable class="pages btn mb-2 btn-secondary lastPg">마지막으로</lable>`;
							}else if(currentPage < endPageNum){
								pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary nexPg">다음</button>`;
								pageNation +=`<button type="button" class="pages btn mb-2 btn-secondary lastPg" data-lastpagenum="${endPageNum}">마지막으로</button>`;
							}
						}				
						$('.colSpan').append(pageNation);	*/
					}
					requestData.fail(function( jqXHR, textStatus ) {
						alert( "Request failed: " + textStatus );
					});

				});
			});
			

				
				// 체크박스 모두 선택 / 개별 선택
				$('.checkbox').on('click',e => {
			        if ($(e.target).is($('.allCheck'))) {
			          const isChecked = $(e.target).prop('checked');
			          $('.checks').prop('checked', isChecked);
			        }else if ($(e.target).is($('.checks'))) {
			          if ($('.checks').length == $('.checks:checked').length) {
			            $('.allCheck').prop('checked', true);
			          } else $('.allCheck').prop('checked', false);
			        }
				});	
				
				
				
			
			</script>
	</th:block>
</html>