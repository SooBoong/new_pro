<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/default}">
	  	  
	<th:block layout:fragment="customContents">
		<div class="container-fluid">
			<div class="row justify-content-center">
				<div class="col-12">
					<h2 class="mb-2 page-title">포인트 관련 기준 관리</h2>
					<div class="row my-4">
						<div class="col-md-12 table-margin-bottom">
							<div class="card shadow">
								<div class="card-body">               
									<!-- tab 버튼 -->
									<ul class="nav nav-pills nav-fill mb-3 bottom-border" id="pills-tab" role="tablist">
									    <li class="nav-item">
									      <a class="nav-link nav-tab active" id="pills-max-tab" data-toggle="pill" href="#pills-max" role="tab" aria-controls="pills-max" aria-selected="true">하루 최대 적립 포인트 횟수 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-expire-tab" data-toggle="pill" href="#pills-expire" role="tab" aria-controls="pills-expire" aria-selected="false">포인트 유효 기간 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-type-tab" data-toggle="pill" href="#pills-type" role="tab" aria-controls="pills-type" aria-selected="false">포인트 타입</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-save-tab" data-toggle="pill" href="#pills-save" role="tab" aria-controls="pills-save" aria-selected="false">포인트 적립 기준</a>
									    </li>
									    <li class="nav-item">
									      <a class="nav-link nav-tab" id="pills-refund-tab" data-toggle="pill" href="#pills-refund" role="tab" aria-controls="pills-refund" aria-selected="false">포인트 환급 기준</a>
									    </li>
									</ul>
									<div class="tab-content mb-1" id="pills-tabContent">	                 
										<!-- 포인트 기준 동적 테이블 -->
										<div class="tab-pane fade show active" id="pills-max" role="tabpanel" aria-labelledby="pills-max-tab"> 
											<h5 class="mb-2 page-small-title">하루 최대 적립 포인트 횟수 기준</h5>
											<p class="card-small-text"> 하루에 적립 가능한 포인트 횟수는 최대 [[${useMaxCount}]]번입니다.</p>
											<table class="table datatables table-hover dataTable-1">
												<thead>
													<tr>
														<th class="not-delete">
															<input type="checkbox" class="custom-control custom-checkbox checkbox allCheck">
														</th>
									                    <th>NO.</th>
									                    <th>횟수 기준 코드</th>
									                    <th>적립 가능 횟수</th>
									                    <th>코드 사용 유무</th>
									                    <th>최초 등록일</th>
									                    <th>관리자 ID</th>
									                    <th>최종 수정일</th>
									                    <th class="last-th">수정/삭제</th>
					                  				</tr>
					               			 	</thead>
												<tbody>
										        	<th:block 	th:unless="${#lists.isEmpty(pointStandardList)}"
										                		th:each ="p , state: ${pointStandardList}">
														<tr> 
															<td>
																<input type="checkbox" class="custom-control custom-checkbox checkbox checks">
															</td>
                                   			 				<td th:text="${state.count+(rowPerPage*(currentPage-1))}"></td>
															<td th:text="${p['횟수 기준 코드']}"></td>
															<td th:text="${p['적립 가능 횟수']}"></td>
															<td th:text="${p['코드 사용 유무']}"></td>
															<td th:text="${p['최초 등록일']}"></td>
															<td th:text="${p['관리자 ID']}"></td>
															<td th:text="${p['최종 수정일']}"></td>
															<td>
					                     						<div class="btn-group" role="group" aria-label="Basic example">
					                     							<!-- 개별/수정 버튼 -->
																	<button type="submit" class="btn mb-2 btn-light" data-toggle="modal" th:data-target="'#modifyBtn' + ${state.count}">수정</button>
					               									<div class="modal fade" th:id="'modifyBtn'+${state.count}" tabindex="-1" role="dialog" aria-labelledby="varyModalLabelModifyMax" aria-hidden="true">
						                 								<div class="modal-dialog" role="document">
																			<div class="modal-content">
																				<div class="modal-header">
																				  <h5 class="modal-title" id="varyModalLabelModifyMax">하루 최대 적립 포인트 횟수 기준 수정</h5>
																				  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				    <span aria-hidden="true">&times;</span>
																				  </button>
					                     										</div>
					                     										<div class="modal-body">
																					<form>
																						<div class="form-group">
																						  <label th:for="'modifyCode'+${state.count}" class="col-form-label">코드</label>
																						  <input type="text" class="form-control" readonly="readonly" th:value="${p['횟수 기준 코드']}" th:id="'modifyCode'+${state.count}">
																						</div>
																						<div class="form-group">
																						  <label th:for="'modifyCount'+${state.count}" class="col-form-label">적립 가능 횟수</label>
																						  <input type="text" class="form-control" th:value="${p['적립 가능 횟수']}" th:id="'modifyCount'+${state.count}">
																						</div>
																						<div class="form-group">
																							<label th:for="'modifyUse'+${state.count}" class="col-form-label">코드 사용 유무</label>
																							<select th:id="'modifyUse'+${state.count}" class="form-control">
																							 	<th:block 	th:unless="${#lists.isEmpty(codeUseList)}"
																											th:each="u : ${codeUseList}">
																								  	<option th:selected="${u} == ${p['코드 사용 유무']}"
																								  			th:value="${u}" 
																								  			th:text="${u}">
																								  	</option>
																								</th:block> 
																							</select>
																						</div>
																						<div class="form-group">
																							<label th:for="'modifyAdmin'+${state.count}" class="col-form-label">관리자 ID</label>
																							<input type="text" class="form-control" readonly="readonly" th:value="${SID}" th:id="'modifyAdmin'+${state.count}">
																						</div>
																						<div class="form-group">
																							<label th:for="'modifyPw'+${state.count}" class="col-form-label">비밀번호</label>
																							<input type="password" class="form-control" th:id="'modifyPw'+${state.count}">
																						</div>
																						<button type="reset" class="btn mb-2 btn-secondary">입력 취소</button>
																						<button type="button" class="btn mb-2 btn-secondary" th:id="'modifyBtn'+${state.count}">수정 확인</button>
																					</form>
																				</div>
																			</div>
						                 								</div>
					               									</div>
								                 					<!-- 개별/삭제 버튼 -->
																	<button type="button" class="btn mb-2 btn-light" th:href="@{/admin/point/PointStandardManage}" data-toggle="modal" th:data-target="'#selectDeleteBtn' + ${state.count}">삭제</button>
																	<div class="modal fade modal-varyModal" th:id="'selectDeleteBtn'+${state.count}" tabindex="-1" role="dialog" aria-labelledby="varyModalLabelSelectDelete" aria-hidden="true">
																		<div class="modal-dialog" role="document">
																			<div class="modal-content">
																				<div class="modal-header">
																					<h5 class="modal-title" id="varyModalLabelSelectDelete">하루 최대 적립 포인트 횟수 기준 삭제</h5>
																					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																						<span aria-hidden="true">&times;</span>
																					</button>
																				</div>
																				<div class="modal-body">
																					<form>
																						<div class="form-group">
																							<label for="sssss" class="col-form-label">코드:</label>
																							<input type="text" class="form-control" readonly="readonly" th:value="${p['횟수 기준 코드']}">
																						</div>
																						<div class="form-group">
																							<label for="message-text" class="col-form-label">적립 가능 횟수:</label>
																							<input type="text" class="form-control" th:value="${p['적립 가능 횟수']}">
																						</div>
																						<div class="form-group">
																							<label for="message-text" class="col-form-label">관리자 ID:</label>
																							<input type="text" class="form-control" readonly="readonly" th:value="${SID}">
																						</div>
																						<div class="form-group">
																							<label for="message-text" class="col-form-label">비밀번호 : </label>
																							<input type="password" class="form-control" >
																						</div>
																					</form>
																				</div>
																				<div class="modal-footer">
																					<button type="reset" class="btn mb-2 btn-secondary">입력 취소</button>
																					<button type="submit" class="btn mb-2 btn-secondary">삭제 확인</button>
																				</div>
																			</div>
																		</div>
																	</div>
					                     						</div>
															</td>
														</tr>  
													</th:block>                
												</tbody> 
												<tfoot>
													<tr>
														<td></td>
														<td class="colSpan" colspan="7">
															<button type="button" class="pages btn mb-2 btn-secondary" th:unless="${currentPage==1}">처음으로</button>
															<label class="btn mb-2 btn-secondary" th:if="${currentPage==1}">처음으로</label>
															<button type="button" class="btn mb-2 btn-secondary" th:if="${currentPage>1}">이전</button>
															<label class="btn mb-2 btn-secondary" th:unless="${currentPage>1}">이전</label>
															<div class="btn-group mr-2" role="group" aria-label="First group">
																<th:block th:each="num : ${#numbers.sequence(startPageNum,endPageNum)}" >
																	<button type="button" class="btn mb-2 btn-secondary" th:if="${currentPage != num}" th:text="${num}"></button>
																	<label class="btn mb-2 btn-secondary current-page-btn foot-pg" th:if="${currentPage == num}" th:text="${num}"></label>
																</th:block>
															</div>				
															<button type="button" class="btn mb-2 btn-secondary" th:if="${currentPage<lastPageNum}">다음</button>
															<label class="btn mb-2 btn-secondary" th:unless="${currentPage<lastPageNum}">다음</label>
															<button type="button" class="pages btn mb-2 btn-secondary lastPg" th:unless="${currentPage==lastPageNum}" th:attr="lastPageNum=${lastPageNum}">마지막으로</button>
															<label class="btn mb-2 btn-secondary" th:if="${currentPage==lastPageNum}">마지막으로</label>
														</td>
														<td>
															<!-- 등록버튼 -->
															<button type="button" class="btn mb-2 btn-secondary"th:href="@{/admin/point/PointStandardManage}" data-toggle="modal" data-target="#varyModalInsert" data-whatever="@mdo">등록</button>
															<div class="modal fade" id="varyModalInsert" tabindex="-1" role="dialog" aria-labelledby="varyModalLabelInsert" aria-hidden="true">
																<div class="modal-dialog" role="document">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title" id="varyModalLabelInsert">하루 최대 적립 포인트 횟수 기준 등록</h5>
																			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				<span aria-hidden="true">&times;</span>
																			</button>
																		</div>
																		<div class="modal-body">
																			<form>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">적립 가능 횟수:</label>
																					<input type="text" class="form-control" value="횟수">
																				</div>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">관리자 ID:</label>
																					<input type="text" class="form-control" readonly="readonly">
																				</div>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">비밀번호 : </label>
																					<input type="password" class="form-control">
																				</div>
																			</form>
																		</div>
																		<div class="modal-footer">
																			<button type="button" class="btn mb-2 btn-secondary" data-dismiss="modal">입력 취소</button>
																			<button type="button" class="btn mb-2 btn-secondary">등록 확인</button>
																		</div>
																	</div>
																</div>
															</div>
															<!-- 선택/삭제 버튼 -->
															<button type="button" class="btn mb-2 btn-secondary select-delete" data-toggle="modal" data-target="#varyModalDelete" data-whatever="@mdo">삭제</button>
															<div class="modal fade" id="varyModalDelete" tabindex="-1" role="dialog" aria-labelledby="varyModalLabelDelete" aria-hidden="true">
																<div class="modal-dialog" role="document">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title" id="varyModalLabelDelete">하루 최대 적립 포인트 횟수 기준 삭제</h5>
																			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				<span aria-hidden="true">&times;</span>
																			</button>
																		</div>
																		<div class="modal-body">
																			<form>
																				<div class="form-group">
																					<label for="recipient-name" class="col-form-label">코드:</label>
																					<input type="text" class="form-control" readonly="readonly">
																				</div>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">적립 가능 횟수:</label>
																					<input type="text" class="form-control" value="횟수">
																				</div>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">관리자 ID:</label>
																					<input type="text" class="form-control" readonly="readonly">
																				</div>
																				<div class="form-group">
																					<label for="message-text" class="col-form-label">비밀번호 : </label>
																					<input type="password" class="form-control">
																				</div>
																			</form>
																		</div>
																		<div class="modal-footer">
																			<button type="button" class="btn mb-2 btn-secondary" data-dismiss="modal">입력 취소</button>
																			<button type="button" class="btn mb-2 btn-secondary" id="varyModalDeleteBtn">삭제 확인</button>
																		</div>
																	</div>
																</div>
															</div>
														</td>
													</tr>
												</tfoot>
											</table>   
										</div>      
										<!-- 포인트 기준 동적 테이블 끝 -->   
									</div>                 
									<!-- tab 끝 -->                
								</div>
							</div>
						</div>
					</div> 
				</div>
			</div>
		</div>
	</th:block>
	<th:block layout:fragment="customJs">
		<script>	
			$(function(){		
				// 데이터테이블 첫번째, 마지막 컬럼 정렬 삭제
				$('.dataTable-1').each(function() {
				    const table = $(this);
				    table.DataTable({
				      autoWidth: true,
				      columnDefs: [{
				            targets: 0,
				            searchable: false,
				            orderable: false,
				            className: 'sorting_disabled'
				            
				      },
				      {
				          targets: table.find('th').length - 1,
				          searchable: false,
				          orderable: false,
				          className: 'sorting_disabled',
				        }]
				      });
				    });
				  $('.dataTable-1').find('.sorting_asc').toggleClass('sorting_asc');
				  });
			
			
			
			// ajax와 제이쿼리로 테이블 동적으로 수정
				 $('.nav-tab').click(e => {			
					
					if($(e.target).is('#pills-max-tab')){
						location.href = `pointStandardManage?currentPage=1&tableId=pills-max`;
						return;
					}				
					
					let tableId = $(e.target).attr('aria-controls');
					let currentPage = $('.current-page-btn').text();	
					currentPage = parseInt(currentPage);			
					
				    console.log(tableId);
					console.log(currentPage);
					
					$('thead').find('th').not(':first, :last').remove();
					$('tbody').find('tr').remove();				
				    
					// 동적으로 테이블 속성과 값 변경
					$('#pills-tab').find('.active').toggleClass('active');
					$(e.target).toggleClass('active');	
					$('.tab-pane').attr('id',tableId).attr('aria-labelledby',`${tableId}-tab`);
					$('.checkbox').prop('checked', false);	
					
				 	 const request = $.ajax({
				 		 	url: '/admin/point/pointStandardManageClick',
							method: 'GET',
							data: { 'currentPage' : currentPage , 'tableId' : tableId},
							dataType: 'json'
				 	});

					request.done(function( response ) {
						if(response){
							console.log(response);
							
							let isTrue = true;
							const pointStandardList = response.pointStandardList;
							console.log(pointStandardList);
							
							
							switch(tableId){
							case 'pills-expire':
								let pointExpire
								for(let list of pointStandardList){
									if(list['코드 사용 유무'] == '사용가능') {
										pointExpire = list['유효 기간'];
									}
								}
								$('.page-small-title').text('포인트 유효 기간 기준');
								$('.card-small-text').text(`포인트 유효 기간은 ${pointExpire}년입니다.`);
								isTrue = true;
								for(let list of pointStandardList){
									for(let arr in list){
										if(isTrue){
											const addTh = $(`<th>${arr}</th>`);
											$('.last-th').before(addTh);											
										}	
										const thColspan = $('thead th').length;
										$('.colSpan').attr('colspan',thColspan-2);
										
									}																	
									isTrue = false;
								}isTrue = true;		
								break;
							case 'pills-type':
								$('.page-small-title').text('포인트 타입');
								$('.card-small-text').text('포인트 타입입니다.');
								isTrue = true;
								for(let list of pointStandardList){
									for(let arr in list){
										if(isTrue){
											const addTh = $(`<th>${arr}</th>`);
											$('.last-th').before(addTh);											
										}	
										const thColspan = $('thead th').length;
										$('.colSpan').attr('colspan',thColspan-2);
										
									}																	
									isTrue = false;
								}isTrue = true;		
								break;
							case 'pills-save':
								$('.page-small-title').text('포인트 적립 기준');
								$('.card-small-text').text('포인트 적립 및 사용 타입 기준입니다.');
								isTrue = true;
								for(let list of pointStandardList){
									for(let arr in list){
										if(isTrue){
											const addTh = $(`<th>${arr}</th>`);
											$('.last-th').before(addTh);											
										}	
										const thColspan = $('thead th').length;
										$('.colSpan').attr('colspan',thColspan-2);
										
									}																	
									isTrue = false;
								}isTrue = true;		
								break;
							case 'pills-refund':
								$('.page-small-title').text('포인트 환급 기준');
								$('.card-small-text').text('포인트 환급 기준입니다.');
								isTrue = true;
								for(let list of pointStandardList){
									for(let arr in list){
										if(isTrue){
											const addTh = $(`<th>${arr}</th>`);
											$('.last-th').before(addTh);											
										}	
										const thColspan = $('thead th').length;
										$('.colSpan').attr('colspan',thColspan-2);
										
									}																	
									isTrue = false;
								}isTrue = true;		
								break;
							case 'pills-max':
								if($('.tab-pane').attr('id') == 'pills-max'){
									location.href = `pointStandardManage?currentPage=${currentPage}&tableId=${tableId}`;
								}
								break;
								}
							}
						});
			   		request.fail(function( jqXHR, textStatus ) {
						alert( "Request failed: " + textStatus );
	   				});
				});      
					 
					 
					// 탭 내의 페이지네이션 클릭했을 때 해당 탭 유지하기 (get방식으로 ajax 요청 - 리다이렉트)	
					$('tfoot button').click(e => {		
						e.preventDefault();
						e.stopPropagation();
						
						let tableId = $('.tab-pane').attr('id');
						
						let currentPage;
						if($(e.target).text() == '처음으로') currentPage = 1;
						else if($(e.target).text() == '이전') currentPage = Number($('.foot-pg').text()) - 1;
						else if($(e.target).text() == '다음') currentPage = Number($('.foot-pg').text()) + 1;
						else if($(e.target).text() == '마지막으로') currentPage = Number($('.lastPg').attr('lastPageNum'));
						else currentPage = $(e.target).text();
						
					    currentPage = parseInt(currentPage);
						console.log(tableId);
						console.log(currentPage);
						
						$('.tab-pane').attr('id',tableId).attr('aria-labelledby',`${tableId}-tab`);
						$('.checkbox').prop('checked', false);
						
					 
					 	 const request = $.ajax({
								url: '/admin/point/pointStandardManage',
								method: 'GET',
								data: { 'currentPage' : currentPage , 'tableId' : tableId},
								dataType: 'text'
					 	});

								request.done(function( response ) {
				   					if(response){
				   						console.log(tableId);
				   						location.href = `pointStandardManage?currentPage=${currentPage}&tableId=${tableId}`;
										console.log
				   	    				return false;
				   					}else{
				   						console.log(response);
				   					}
				   				});
				   				 
				   				request.fail(function( jqXHR, textStatus ) {
									alert( "Request failed: " + textStatus );
				   				});
					});      
					
					
				
				// 체크박스 모두 선택 / 개별 선택
				  $('.checkbox').click(e => {
			        if ($(e.target).is($('.allCheck'))) {
			          const isChecked = $(e.target).prop('checked');
			          $('.checks').prop('checked', isChecked);
			        }
			
			        if ($(e.target).is($('.checks'))) {
			          if ($('.checks').length == $('.checks:checked').length) {
			            $('.allCheck').prop('checked', true);
			          } else $('.allCheck').prop('checked', false);
			        }
			      });	
				
				
				
			
			</script>
	</th:block>
</html>