<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{user/layout/default}">
	<th:block layout:fragment="customContents">
  
 <!-- ================ start banner area ================= -->
  <section class="page-banner-area" id="category">
    <div class="container h-100">
        <div class="text-center">
          <h1>추가 컵 배송 신청</h1>
          <nav aria-label="breadcrumb" class="banner-breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/"><span class="fe fe-16 fe-home"></span></a></li>
              <li class="breadcrumb-item"><span class="fe fe-16 fe-chevron-right"></span></li>
              <li class="breadcrumb-item active" aria-current="page">추가 컵 배송 신청</li>
            </ol>
          </nav>
      </div>
    </div>
  </section>
 
	  <!-- ================ end banner area ================= -->

  <!--================Point table Area =================-->
  <section class="order_details section-margin--small">
    <div class="container">
      <div class="order_details_table" style="height: 300px">
        <h2>99CUP Order </h2>
        <p>추가로 필요한 99컵 수량과 배송희망 날짜를 입력해주세요</p>
        <form id="addCupForm" method="post" th:action="@{/partner/applyAddCup}">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">사업장 코드</th>
                <th scope="col">무인기기 번호</th>
                <th scope="col"><label for="addCupAmount">추가 배송 수량</label></th>
                <th scope="col"><label for="addCupDate">배송 희망 날짜</label></th>
              </tr>
            </thead>
           	<tbody class="tbody">
              <tr>
                <td>
                	<select id="partnerCode" name="partnerCode" size="1" class="nice-select addCupselect">
								<th:block th:unless="${#lists.isEmpty(partnerCodeList)}"
										  th:each="p: ${partnerCodeList}">
									<option class="nice-select option" th:value="${p.partnerCode}" th:text="|${p.partnerCode} :::: ${p.partnerName}|"></option>
								</th:block>
					</select>
                </td>
                <td class="kioskTd"></td>
                 <td>
                  <input type="text" class="nice-select" id="addCupAmount" name="outAmount"/>
                </td>          
                <td>
                  <div class="input-group">
                    <input type="text" class="form-control drgpicker" id="addCupDate" name="deliveryDesiredDate">
                    <div class="input-group-append">
                      <div class="input-group-text" id="button-addon-date"><span class="fe fe-calendar fe-16"></span></div>
                    </div>
                  </div>
                </td>        
              </tr>
			</tbody>
			<tfoot>
				<tr>
					<td colspan="4" class="addCupTfoot">
						<button type="button" class="addCupBtn" id="addCupBtn">
							<img class="applyImg" alt="신청" src="/user/img/button/apply.png">
						</button>
					</td>
				</tr>
			</tfoot>
          </table>
         </form>
        </div>
      </div>
  </section>
  <!--================End Order Details Area =================-->
   </th:block>
   <th:block layout:fragment="customJs">
	<script type="text/javascript" th:inline="javascript">
	
	// 유효성검사 함수
	const validCheck = element => {
	    let data = $(element).val();
	    let eleId = $(element).attr('id');
	    if (typeof data == 'undefined' || data == null || data == '' ) {
	        let cate = $(`label[for="${eleId}"]`).text();
	        alert(`${cate} 필수 입력항목입니다.`);
	        $(element).focus();
	        return false;
	    }
	    return true;
		}
	
	// 선택된 값으로 td 값 삽입 -->change
	function loadKioskNum(){
		let $selectedValue = $('.addCupselect option:selected').val();
		console.log($selectedValue);
		//생성된 td 제거
		 $('.kioskTd').empty();
		
		const request =$.ajax({
            url: '/partner/addCupKioskNum',
            type: 'GET',
            data: { partnerCode: $selectedValue}, // 서버에 전송할 데이터
		})	
		  
		request.done(function(response) {
			console.log(response);
		    if (response.length > 1) {
		        let $kioskNum = $('<select></select>').attr('size', '1').attr('name', 'kioskSerialNum').addClass('nice-select');
		        $.each(response, function(idx, item) {
		            let kioskOption = $('<option></option>').val(item.kioskSerialNum).text(item.kioskSerialNum);
		            $kioskNum.append(kioskOption);
			        $('.kioskTd').append($kioskNum);
		        });
		        
		       
		    } else {
		   		let $kioskNum = $('<input />',{ name:'kioskSerialNum', value:response[0].kioskSerialNum}).prop('readonly',true)
		        $('.kioskTd').append($kioskNum);
		    }
		
		});
	}
	$(document).ready(function() {
	    loadKioskNum();
	    
	    // select 값 변경 시 호출
	    $('.addCupselect').change(loadKioskNum);
	});
	//버튼 클릭 이벤트
	$('#addCupBtn').click(function(){
		const validateEle = $('#addCupForm select,input');   			
		let isSubmit = false;
		validateEle.each((idx, item) => {    				
			isSubmit = validCheck(item);
			return isSubmit;
		})
		if(isSubmit) {
			alert("신청완료")
			$('#addCupForm').submit();
		}
	})
	//데이트 피커
	$('.drgpicker').daterangepicker(
		      {
		        singleDatePicker: true,
		        timePicker: false,
		        showDropdowns: true,
		        locale:
		        {
		          format: 'YYYY-MM-DD'
		        }
	});			
				
	</script>
</html>